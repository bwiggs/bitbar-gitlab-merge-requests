#!/bin/bash

GITLAB_API_TOKEN="TOKEN"
GITLAB_PROJECT_ID="PROJECT_ID"
GITLAB_HOST="gitlab.com"

# ------------------------------------------------------------------------------

# GITLAB SETTINGS
GITLAB_PARAMS='&state=opened'
GITLAB_PATH="/groups/${GITLAB_PROJECT_ID}/merge_requests"

GITLAB_URL="https://${GITLAB_HOST}/api/v4${GITLAB_PATH}?private_token=${GITLAB_API_TOKEN}${GITLAB_PARAMS}"

# COMMANDS
CMD="curl -s -k ${GITLAB_URL}"
JQ="/usr/local/bin/jq"

# GITLAB LOGOS
GITLAB_LOGO_GRAYSCALE="iVBORw0KGgoAAAANSUhEUgAAABAAAAAOCAQAAACMJlQBAAAABGdBTUEAALGPC/xhBQAAAAJiS0dEAP+Hj8y/AAAAB3RJTUUH4wMcDSMOUKKYTgAAAURJREFUGNNdkL0vQ3EUhp/zu9UP1NdtXGWwkIhuEt9JBxVDq4lURCySViRiMpCIv8BqsIrFIrEYRCRGC7vFLGUQg6bStL97LC2tM77Pkzd5DwBb7tYR/65wuO0BGACmOCgMtWBP9u3cryDpYA8LLQXJoCvpurDZqUs+km3mJuuji4VuMKCTjFTR5LrbwBtddqGGDFdnIQDjmZKxKl75LF80gE9Xf2QQdaQzw61cR2pP74lPHL54RwDFI4qll/6X4ISpTksiRkgtIRW1WNCgWkLq4oxW5o1f5jVEHKOOhFGUMAExGicMb6Zk1h5tqnYblQEROgBoR/AkKrV7P5V7cODyY/nKqUZmaPumJIY+PIlV/OPA7koRpDHtaklO3sae8TUh8Rf2cjf1jzSE1TtS7oVLTGKXpBq4qQHgw5zvaCB/6tq/7AeFVmKW7qum2wAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOS0wMy0yOFQxODozODo0OC0wNTowMMtw03IAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTktMDMtMjhUMTg6MzU6MTQtMDU6MDDAk4RuAAAAAElFTkSuQmCC"
GITLAB_LOGO_CROSS="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABwUlEQVR4AWySA4wdURiFv5m7NoPaDBvUChsUQW2bsVNGtd3YZm3HaNSobte7wfrd/ifvZjMPSc7g6BIgMjhDqaEyoCRwUUIvyauHj8rhhfHeijjqAr4bVhmqDUVC+F5j+FUZR50TiuN9ocgRRt5cE9P/ZiT+8Qh8eUwPsMXQGLBN3BPTXprHvAPABkMJoenPaxP8JASZVNIL7Dcc1PerhC6vMiFLZWQ/apeYVdJn6E+GBc0yhp+EgpIVZUUn6hxexuySbE7/8q6qLDkTloD7tYkr92fgawtyA9lheeT9vZFbyvL7FmU9d/nSdAx/ZRa+JpTkC0uTp+kovucOX5vvUUn/PRb33jPyPP7qQlIyvcxTIK7apT1N5/C99/H9d1lC53Vmtd/g14PdNr3CZDh/iQaQt/0mf7vuMB+gZO4EjtQUMvgyz4aJy5lJAYMLJ3EseQ9+PBqRZ80ujZd5jpHEMerxL3mRFNZyLo1z/uJYl8pemnTgV8imr3K1XRoJulAVMb0nl/GhaQW+aTnevj9XOHo1sgaqMi+wfugehKYNoVVTWz1qFLWdeznYuYej06dT938gMWhGewZSC89MhLIrIXkA3dU2TQmPb0MAAAAASUVORK5CYII="
GITLAB_LOGO_DOT_GREEN="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB4UlEQVR4AWKgGvikAWiFHGDuCMIoen/rrWrbfaxt27bduLYR1bbdoLYR17bdRb23s1ubJznjDxkpsemX+v7ynU/pTW+y5Pga06dVNv2JHlmBuNT4AYYINP3q/adetfa3CULaRAYT0fCqzfEDdF+i+gwp1P3qTHzO3dxJPYZfPcOgSj2orcAPsALqAueN4dMuPcwL5VPm9Gppy6+8Mb0igU+9fT116sT4igeJIOu5teuWePPMm8h+kjlpJXyAnTCetUHWgM2aoF06bL3uVabpPsnVWb8uFbbGvRe6bztgIhy4AnGch+PsD7K1sL2wDvjar/JNQHF0125Q+/dv+gnn4qyI9UAsSnE+yJnC7rDZCmRz2M/yyLYhAh23F1HsZrUSGKwnsVndBO4dHkkuADkHFcFZKCA217kY5GTYbC8UVV6XjLB1n8atBVX6WkqUD0Uy8kEY5YOR7n7n6MiHovOicOBsZBebjVwCcpywrbAm3ARNKshuMF7go06SojWl4/icS3MRK5IM5EJYHAqyMWwzpLhti8pfJHD2gXqSje8hklQQnmJf8FXRaDat7PluB3mqy0fxI7gUqTgNi9gQ3Fsv8ss/OOTumbeGXBU/g0Q4e6ILu6NHobpSdaei07Yzu8H/i7dvaitIBVvhzAAAAABJRU5ErkJggg=="
GITLAB_LOGO_DOT_RED="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB4ElEQVR4AWKgGvikwSsMaIUcYPWIoiA8z36L2vbP2rZt27YVtlFt240aG7Vt24t6p2e3Nif5Ls/MhRVIGfvLOr8ymr70Gb7ZsPxaHSugP7KDCVl+ZDbFaAXU+099apNvA8LabIZ0mj61A34gw6+3YFihEVAXf7Fxt0i6ZDOgnmFIpRHSNuEHsoPqKrfG9GuXHhaD8ik5h1rFDihvLJ8E+NXb17NkSfO1+YGOVKOIdt2Wmmc+3XmSJ13tj5vsjZlsArIhHDYCnSoROw2fssDwp3i449eVI7Z5+4JX2xOz35k3IYErcJzjQXYReghNwdcBlW+Cios39kw93teME5bjrHiTIYPKXAlysTBA0jtL3wHOs6KpjilGl/0FUpzp2aPZX4nh9FzRPDokklwFchlqgUtQUibXuRbkXAnoIcgprytFOYZf4568qRyhxfBYjgiaecGj0rvzQ8MjH8rNy8EVl6KATHZxHcgZQjehEbyAKWnjPDPz4yNuSL80McfxuS4tR7yETORq2JwKsg0cK6x415aTvwhw5/2UGAffk4TUFE5xLPiqXCynZYj57g26p8bsw4/E9cjMBVjDVlJcJfKLP5Dem/dMjauHn4lEJAehLwdgYN+0cQ3cE91ru71n/l96C0iELMOE9ZplAAAAAElFTkSuQmCC"
GITLAB_LOGO_DOT_BLUE="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB3klEQVR4Aa2QAxBVWxSG//cyD7Lty2zbtu3G2bZt2+aYjbNtd5D337rKrm/m216YjX/G87zJUji+ZIN++s6rDaAndRp8ieM1ajg+84nrT5QB38GWQMenP3zu0Rt8nSBozGbApO3R2+A7WF6zCYMaLZ++GJ9yv0CqpLZPP8eATitgbMJ3cP36qtAb22tceVwI2sfMWfQKrk9753gkgVe/ezNDhhT4gkcmklsFjJuuvHnhMdWzHKmqIwa7YwobgKwLxXqgqvDfTsujLbC8ySLK+m35/7aF78Xw266YHQnehERcgZMcArKD2EVsCL716Xzn18KG1uGgLtE3g8XlOC+xSSGL8lwJcrHYB4rtQbaBelEwubIlMOS2UhVU4UYz+V+TgyzcdCb3jC1KrgK5DNXAJSgqm5tcC3IuFLuIUuVtuTjK8hrcXLwi0fIYMfM+seY1MeN+eL99YsnH0nkphOBS5JHNfq4DOVnsJNZDOEHBGnMiwZv5UUmSpNG2k/iUK8uRUJIM42q4HAWyBZQT1MJtS+XPEoT3TQ4pfAtJUlU8w0Hgm1LxWaj2rG92gPr7juN7cD3ScwHWsBm4p0nRz/9A5vC+4YFa+BEk/mc/9GQf9E3QdHedcEVpOzyHg/8R7wH7LUK3IoUNzgAAAABJRU5ErkJggg=="

ICON_IDLE=$GITLAB_LOGO_GRAYSCALE
ICON_ERROR=$GITLAB_LOGO_CROSS
ICON_OPEN_REQUEST=$GITLAB_LOGO_DOT_BLUE
# ------------------------------------------------------------------------------

data=`$CMD`
if [[ $data = "" ]]; then
  echo "|image=${ICON_ERROR}"
  echo "---"
  echo "${GITLAB_HOST} unavailable | color=red"
  exit 0
fi

count=`echo $data | $JQ length`

if [[ $count -eq "0" ]]; then
  echo "|image=${ICON_IDLE}"
  echo "---"
  echo "No open merge requests for you"
  exit 0
fi


echo "|image=${ICON_OPEN_REQUEST}"
echo "---"
$CMD | $JQ -r '.[] | .title  + " | href=\""+.web_url+"\"", "Author: "+.author.name, "Branch: " + .source_branch, "State: " + .state, "Merge: " + .merge_status, .blank + "---"' | sed 's/can_be_merged/ready/
# {title, merge_status, author, web_url, merge_status}'