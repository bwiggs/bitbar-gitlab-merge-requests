#!/bin/bash

GITLAB_API_TOKEN="TOKEN"
GITLAB_PROJECT_ID="PROJECT_ID"
GITLAB_HOST="gitlab.com"

# ------------------------------------------------------------------------------

# GITLAB SETTINGS
GITLAB_PARAMS='&state=opened'
GITLAB_PATH="/groups/${GITLAB_PROJECT_ID}/merge_requests"

GITLAB_URL="https://${GITLAB_HOST}/api/v4${GITLAB_PATH}?private_token=${GITLAB_API_TOKEN}${GITLAB_PARAMS}"

# COMMANDS
JQ="/usr/local/bin/jq"
CMD="curl -s -k ${GITLAB_URL}"

# GITLAB LOGOS
GITLAB_LOGO_GRAYSCALE="iVBORw0KGgoAAAANSUhEUgAAABAAAAAOCAQAAACMJlQBAAAABGdBTUEAALGPC/xhBQAAAAJiS0dEAP+Hj8y/AAAAB3RJTUUH4wMcDSMOUKKYTgAAAURJREFUGNNdkL0vQ3EUhp/zu9UP1NdtXGWwkIhuEt9JBxVDq4lURCySViRiMpCIv8BqsIrFIrEYRCRGC7vFLGUQg6bStL97LC2tM77Pkzd5DwBb7tYR/65wuO0BGACmOCgMtWBP9u3cryDpYA8LLQXJoCvpurDZqUs+km3mJuuji4VuMKCTjFTR5LrbwBtddqGGDFdnIQDjmZKxKl75LF80gE9Xf2QQdaQzw61cR2pP74lPHL54RwDFI4qll/6X4ISpTksiRkgtIRW1WNCgWkLq4oxW5o1f5jVEHKOOhFGUMAExGicMb6Zk1h5tqnYblQEROgBoR/AkKrV7P5V7cODyY/nKqUZmaPumJIY+PIlV/OPA7koRpDHtaklO3sae8TUh8Rf2cjf1jzSE1TtS7oVLTGKXpBq4qQHgw5zvaCB/6tq/7AeFVmKW7qum2wAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOS0wMy0yOFQxODozODo0OC0wNTowMMtw03IAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTktMDMtMjhUMTg6MzU6MTQtMDU6MDDAk4RuAAAAAElFTkSuQmCC"
GITLAB_LOGO_CROSS="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABwUlEQVR4AWySA4wdURiFv5m7NoPaDBvUChsUQW2bsVNGtd3YZm3HaNSobte7wfrd/ifvZjMPSc7g6BIgMjhDqaEyoCRwUUIvyauHj8rhhfHeijjqAr4bVhmqDUVC+F5j+FUZR50TiuN9ocgRRt5cE9P/ZiT+8Qh8eUwPsMXQGLBN3BPTXprHvAPABkMJoenPaxP8JASZVNIL7Dcc1PerhC6vMiFLZWQ/apeYVdJn6E+GBc0yhp+EgpIVZUUn6hxexuySbE7/8q6qLDkTloD7tYkr92fgawtyA9lheeT9vZFbyvL7FmU9d/nSdAx/ZRa+JpTkC0uTp+kovucOX5vvUUn/PRb33jPyPP7qQlIyvcxTIK7apT1N5/C99/H9d1lC53Vmtd/g14PdNr3CZDh/iQaQt/0mf7vuMB+gZO4EjtQUMvgyz4aJy5lJAYMLJ3EseQ9+PBqRZ80ujZd5jpHEMerxL3mRFNZyLo1z/uJYl8pemnTgV8imr3K1XRoJulAVMb0nl/GhaQW+aTnevj9XOHo1sgaqMi+wfugehKYNoVVTWz1qFLWdeznYuYej06dT938gMWhGewZSC89MhLIrIXkA3dU2TQmPb0MAAAAASUVORK5CYII="
GITLAB_LOGO_DOT_GREEN="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB4UlEQVR4AWKgGvikAWiFHGDuCMIoen/rrWrbfaxt27bduLYR1bbdoLYR17bdRb23s1ubJznjDxkpsemX+v7ynU/pTW+y5Pga06dVNv2JHlmBuNT4AYYINP3q/adetfa3CULaRAYT0fCqzfEDdF+i+gwp1P3qTHzO3dxJPYZfPcOgSj2orcAPsALqAueN4dMuPcwL5VPm9Gppy6+8Mb0igU+9fT116sT4igeJIOu5teuWePPMm8h+kjlpJXyAnTCetUHWgM2aoF06bL3uVabpPsnVWb8uFbbGvRe6bztgIhy4AnGch+PsD7K1sL2wDvjar/JNQHF0125Q+/dv+gnn4qyI9UAsSnE+yJnC7rDZCmRz2M/yyLYhAh23F1HsZrUSGKwnsVndBO4dHkkuADkHFcFZKCA217kY5GTYbC8UVV6XjLB1n8atBVX6WkqUD0Uy8kEY5YOR7n7n6MiHovOicOBsZBebjVwCcpywrbAm3ARNKshuMF7go06SojWl4/icS3MRK5IM5EJYHAqyMWwzpLhti8pfJHD2gXqSje8hklQQnmJf8FXRaDat7PluB3mqy0fxI7gUqTgNi9gQ3Fsv8ss/OOTumbeGXBU/g0Q4e6ILu6NHobpSdaei07Yzu8H/i7dvaitIBVvhzAAAAABJRU5ErkJggg=="
GITLAB_LOGO_DOT_RED="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB4ElEQVR4AWKgGvikwSsMaIUcYPWIoiA8z36L2vbP2rZt27YVtlFt240aG7Vt24t6p2e3Nif5Ls/MhRVIGfvLOr8ymr70Gb7ZsPxaHSugP7KDCVl+ZDbFaAXU+099apNvA8LabIZ0mj61A34gw6+3YFihEVAXf7Fxt0i6ZDOgnmFIpRHSNuEHsoPqKrfG9GuXHhaD8ik5h1rFDihvLJ8E+NXb17NkSfO1+YGOVKOIdt2Wmmc+3XmSJ13tj5vsjZlsArIhHDYCnSoROw2fssDwp3i449eVI7Z5+4JX2xOz35k3IYErcJzjQXYReghNwdcBlW+Cios39kw93teME5bjrHiTIYPKXAlysTBA0jtL3wHOs6KpjilGl/0FUpzp2aPZX4nh9FzRPDokklwFchlqgUtQUibXuRbkXAnoIcgprytFOYZf4568qRyhxfBYjgiaecGj0rvzQ8MjH8rNy8EVl6KATHZxHcgZQjehEbyAKWnjPDPz4yNuSL80McfxuS4tR7yETORq2JwKsg0cK6x415aTvwhw5/2UGAffk4TUFE5xLPiqXCynZYj57g26p8bsw4/E9cjMBVjDVlJcJfKLP5Dem/dMjauHn4lEJAehLwdgYN+0cQ3cE91ru71n/l96C0iELMOE9ZplAAAAAElFTkSuQmCC"
GITLAB_LOGO_DOT_BLUE="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB3klEQVR4Aa2QAxBVWxSG//cyD7Lty2zbtu3G2bZt2+aYjbNtd5D337rKrm/m216YjX/G87zJUji+ZIN++s6rDaAndRp8ieM1ajg+84nrT5QB38GWQMenP3zu0Rt8nSBozGbApO3R2+A7WF6zCYMaLZ++GJ9yv0CqpLZPP8eATitgbMJ3cP36qtAb22tceVwI2sfMWfQKrk9753gkgVe/ezNDhhT4gkcmklsFjJuuvHnhMdWzHKmqIwa7YwobgKwLxXqgqvDfTsujLbC8ySLK+m35/7aF78Xw266YHQnehERcgZMcArKD2EVsCL716Xzn18KG1uGgLtE3g8XlOC+xSSGL8lwJcrHYB4rtQbaBelEwubIlMOS2UhVU4UYz+V+TgyzcdCb3jC1KrgK5DNXAJSgqm5tcC3IuFLuIUuVtuTjK8hrcXLwi0fIYMfM+seY1MeN+eL99YsnH0nkphOBS5JHNfq4DOVnsJNZDOEHBGnMiwZv5UUmSpNG2k/iUK8uRUJIM42q4HAWyBZQT1MJtS+XPEoT3TQ4pfAtJUlU8w0Hgm1LxWaj2rG92gPr7juN7cD3ScwHWsBm4p0nRz/9A5vC+4YFa+BEk/mc/9GQf9E3QdHedcEVpOzyHg/8R7wH7LUK3IoUNzgAAAABJRU5ErkJggg=="
GITLAB_LOGO_DOT_BLUE="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACDklEQVR4AYXTQ4BcWxCA4b/O2PNsm7Ft23bWsW2sYtu2bdu2jXbfroyN7xrHVXKvzJ8ACPItEKjoTbIgyI+AT9G7AIYECg0V2pMNhdYKzUhgEmoNVqigUF6Qj7JoPVKhvEIFQcKSKlD4HcgB/KEx1yxa/xf4m5irwp8ph1Ac+AwIBcqSCX+1SgsaAXwElALwF7cEayDlEBIQ85N8Ivi9/vrNeeEZSIXT0T/K++8m3Rte+Uf3AyJ9DhQpqx6Z6P9ZHetP703JrW8goZKctpeyyPveYzv6cVHpk6ub4dPfv78j5ptmUdM/+s1+jZa2ZdQL25Ej6mfXv2It+L2b2hgm1zHqQETg3RPh9sso+vzUg41fVMNn/IkjxAm27PQMG6udv5o3QLzzfj+EUJCXKDcRLPDYVft52sjoH7uBCBn5SF4wKnrwSQO8RVE+QvgKFVHeBEfK5i8rghEy80o/Ydqb+p8YEZohDIur6EvEfKz61HzE44AvQcnSUVcul3k4yzz186OfCC3x44J+i/iHWfipRbbU5zEA96cbX0xFqwRqEyJLvv7uhfcPc42sKVjug4YUYiq5qkibqKh3PRp/vO5JKO/JlNd9E+frKQnZmJ5pHFay2/2Og1Z4auZ3+oUFpWw5rrDjZad7Z0qv8ScTvoW23d0LjW+4z/ZnqbtBv9XF+P+DqpuYbhPT8r0LlU8AfAAP9cpxmU/qkwAAAABJRU5ErkJggg=="
GITLAB_LOGO_SUCCESS="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAClUlEQVR4AXWSA2AcbRiE70dtt+ewtm3btm0fatu2G9u2bdt2dm+638bJdQ7LeV5ygiQCTrBE2DNAytcOkgrE5FrZL0AqOBsgERxtfJ/9Y4yzPOS8dOalNcrMMefE7bzkPCtvGU835YxqqyYAHznvitsFLrxl/Gc4Mvi/phDhUHc5L4MJkhQkFfZuAAg9I+zmKeO5uDAA5hgcdFbYszHAT8I/6ibngvlR/lL+rgaAxBvimcFXBNkBV/gIusIvirookgdLRCtCJKJVYeeFK2MlgrXBlwV27lcE8L7MR/RV/mc84DavBVToat4r/KaO3A+q7C/ugaiCSbfEQ84tsbkoKHlwf3Cp7Ns8+qT2Ckh/LcLj7xPiD38fN6gWQJn1jqww10TRdzXkf1FFxisVeF3kQu+qGHs/LcR1n3dwzAhGVGEavHKi8SJMD/MsT7l0+7F0XBXAtHdMpW1vlBtrovCrGvI+qMD9pgh7Py7E7zgHUAoajeWRGYaF1uc9Onxb2J9Da/UexUB0K61702V6TCafVfH57VBcYyI3NtMKBUqoMhBpxdkr+ultecLWQX/p05k26n2BsuidXaSljsta8+DApE1UqaBYo6LKBLnvB5RS5UgpySZZRNeOAzLN/6CvuTjXsLffOcNVbM1E32Ns8DbSBD9ibTDd/Di+xViD4PIrirHN+VZ5k62L+tG730ajjQ7e2ZEgsk7xxmSzIxhjvJ/A2GyIMsvysNLuQprSvRdprdv1PMyAQrUc0vxhkuTeoCd2aX4YZrhbSymg1Ze5vNmWpx09MkOhTEnFmdjufDu+648l05UCyI/MmYyKdDulJIupuYhNm0QmZqHWmo2cT+P//SuA/MicyahIt0nDSM0kbRKZmMk7fwC2H1knpxFCFAAAAABJRU5ErkJggg=="
GITLAB_LOGO_FAILED="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACjklEQVR4AW1SA5DdABCtbbfhsbZt27Zt97O2Oaht2+3Ztq1vJ91mz8ibifOwKBe0jyoXvI9uFiAhnwZJKBafxY4ACbU7YB+1ufT7vBsJNcJDRqQLP80SI8fsYWt7yYgv3lLiecou++plBHxkxAE3eQvwlpKXYFPHimVF6M7uMiJDMEkKktAtSwiE7qIbe0oJFxdBQLgGB+2mm5UW8JWQm9FAODg/CbmihEDiEXZ48AEqO+AACUEHSH2UgpEF72OmhexjZgRLmOnhcmZ2mIL84S8jIEBBQMRh6jY8b12lUMD63PmU7p4jqG7Y4wFxZxirENcouBnd97YwBqymTInrOvCJ63tA0oYukL7dKT5tSfMOhQLch5aR1o/OoL/vAJo79pBxzQ48lQS472gBIUs6QsYFJRi9XMAaHwumID9Q3bsCiUvGukT2JPvkCbxvGWP73hIsb51Bd9cBVDftIVhJIhm0754C8DyUhsnfAxJXTPaI6NKkbTn+Scsegshz29eWvPmlM2iFFAm7WEg/r0Qy8AY9WKJCATgOrAkxwGVlAEL7/um/mFGdLuTWwd9p1YB/01Ju+9Qy2/jIEVK3dgSjpwsgkJy8bjZkXTkGSevngO7rG0DY0lMwRUzhOEDqXJF/1XKi5amTX9q2XkLNMYBAZyRH9mYgZdsS4DQqQPA6DaTuWmEps3XmK2yb5OW9fpkCfQCBsdEZyYlLxoPB5Xuebk6mkGxWmujeRw9suUJ19yoH+GNWOmBsdEayJTIEEAa3nxA7qdcTUYGIDvWJhMXjfmO3xWBLTYLU3SvjhVEORYLogXPGUWG3sWFYM8ZGZyRHDXCaH0NXqlBIEDtwzjgq7DY2DGuOndjrCTojGf/5DypoWaRGJX/ZAAAAAElFTkSuQmCC"

ICON_IDLE=$GITLAB_LOGO_GRAYSCALE
ICON_ERROR=$GITLAB_LOGO_CROSS
ICON_OPEN_REQUEST=$GITLAB_LOGO_DOT_BLUE
# ------------------------------------------------------------------------------

data=`$CMD`
if [[ $data = "" ]]; then
  echo "|image=${ICON_ERROR}"
  echo "---"
  echo "${GITLAB_HOST} unavailable | color=red"
  exit 0
fi

count=`echo $data | $JQ length`
if [[ $count -eq "0" ]]; then
  echo "|image=${ICON_IDLE}"
  echo "---"
  echo "No open merge requests for you"
  exit 0
fi

echo "|image=${ICON_OPEN_REQUEST}"
echo "---"
$CMD | $JQ -r '.[] | .title  + " | href=\""+.web_url+"\"", "Author: "+.author.name, "Assignee: "+.assignee.name, "Branch: " + .source_branch, "State: " + .state, "Merge: " + .merge_status, .blank + "---"' | sed 's/can_be_merged/ready/
# {title, merge_status, author, web_url, merge_status}'
